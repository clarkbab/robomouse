#! /usr/bin/env python3

import time
import sys
import pdb
import numpy as np
from optparse import OptionParser

from maze import Maze
from mice.blind_mouse import BlindMouse
from display import Display
from controller import Controller

if __name__ == '__main__':
    # Parse options.
    parser = OptionParser()
    parser.add_option('-d', '--delay', dest='delay', help='delay between steps in ms.', default=1000, type='int')
    parser.add_option('-D', '--display', action='store_true', dest='display', help='show display', default=False)
    parser.add_option('-M', '--maze', dest='maze', help='path to a maze file.')
    parser.add_option('-m', '--mouse', dest='mouse', help='path to a mouse file.')
    parser.add_option('-p', '--pause', action='store_true', dest='pause', help='pause between runs', default=False)
    parser.add_option('-s', '--max_steps', dest='max_steps', help='max number of steps per run.', default=1000, type='int') 
    parser.add_option('-v', '--verbose', action='store_true', dest='verbose', help='log info.', default=False)
    opts, args = parser.parse_args()
    
    # Check opts.
    if opts.pause and not opts.display:
        print("Can't pause without display.")
        sys.exit(1)

    # Create a maze based on input argument on command line.
    maze = Maze(opts.maze)
    
    # Create the display.
    display = None
    if opts.display: display = Display(maze)
        
    # Create and place the mouse.
    mouse = BlindMouse(maze.dim)
    init_state = { 'pos': np.array([8, 2]), 'heading': Maze.NORTH }

    # Create manager.
    controller = Controller(
        mouse,
        maze,
        init_state,
        max_steps=opts.max_steps,
        delay=opts.delay,
        pause=opts.pause,
        verbose=opts.verbose
    )

    # Run the game.
    if display:
        controller.run_with_display(display)
    else:
        controller.run()

    # Print results.
    print(f"Steps: {controller.step}")
    print(f"Final score: {controller.score()}")

